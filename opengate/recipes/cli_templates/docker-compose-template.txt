version: '3.8'

services:
  training-container:
    build:
      context: {context}
      dockerfile: {plan_folder_name}/generated/Dockerfile
      no_cache: true
    container_name: training-container
    volumes:
      - ./metadata:/app/{plan_folder_name}/metadata
    ports:
      - "5001:5000"
    environment:
      - MLFLOW_TRACKING_URI=http://training-container:5001
      - MLFLOW_ARTIFACT_ROOT=/app/{plan_folder_name}/metadata
    networks:
      - mlflow_network

  mlflow-ui:
    image: python:3.11-slim
    container_name: mlflow-ui
    working_dir: /app
    environment:
      - MLFLOW_TRACKING_URI=http://training-container:5001
      - MLFLOW_ARTIFACT_ROOT=/app/{plan_folder_name}/metadata
    volumes:
      - ./metadata:/app/{plan_folder_name}/metadata
    ports:
      - "5002:5000"
    command: >
      sh -c "mkdir -p /app/{plan_folder_name}/metadata/mlflow &&
             chmod -R 777 /app/{plan_folder_name}/metadata/mlflow &&
             chmod -R 777 /app/{plan_folder_name}/metadata/mlflow/mlartifacts &&
             pip install mlflow=={mlflow_version} &&
             mlflow ui --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:////app/{plan_folder_name}/metadata/mlflow/mlruns.db --default-artifact-root /app/{plan_folder_name}/metadata"
    depends_on:
      - training-container
    networks:
      - mlflow_network

networks:
  mlflow_network:
    driver: bridge
